{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Python Compiler - Hardhat Enterprises{% endblock %}

{% block content %}
<!-- Add proper spacing after navigation -->
<div class="container-fluid mt-5 pt-4">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-code"></i> Python Compiler</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Categories</h6>
                        <div class="list-group">
                            {% for category in categories %}
                            <a href="#" class="list-group-item list-group-item-action filter-category" data-category="{{ category }}">
                                {{ category|title }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <a href="{% url 'compiler_history' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-history"></i> My History
                            </a>
                            <a href="{% url 'compiler_leaderboard' %}" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-trophy"></i> Leaderboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-play-circle"></i> Code Editor</h4>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-light" onclick="runCode()" style="display: block !important; visibility: visible !important; opacity: 1 !important; z-index: 9999;">
                            <i class="fas fa-play"></i> Run Code
                        </button>
                        <button class="btn btn-light" onclick="clearCode()" style="display: block !important; visibility: visible !important; opacity: 1 !important;">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Code Editor -->
                    <div class="mb-3">
                        <label for="codeEditor" class="form-label">Python Code:</label>
                        <textarea id="codeEditor" class="form-control" rows="15" placeholder="Write your Python code here..."># Welcome to Hardhat Python Compiler!
# Try this simple example:

def greet(name):
    return f"Hello, {name}! Welcome to Hardhat Enterprises."

# Test the function
print(greet("Developer"))
print("Python compiler is working perfectly!")</textarea>
                        
                        <!-- Test Buttons -->
                        <div class="mt-3">
                            <button class="btn btn-success" onclick="runCode()" style="margin-right: 10px;">
                                <i class="fas fa-play"></i> Run Code (Test)
                            </button>
                            <button class="btn btn-secondary" onclick="clearCode()">
                                <i class="fas fa-trash"></i> Clear (Test)
                            </button>
                        </div>
                    </div>

                    <!-- Input Section -->
                    <div class="mb-3">
                        <label for="inputData" class="form-label">Input Data (optional):</label>
                        <textarea id="inputData" class="form-control" rows="3" placeholder="Enter input data here (one per line)..."></textarea>
                    </div>

                    <!-- Output Section -->
                    <div class="mb-3">
                        <label class="form-label">Output:</label>
                        <div id="outputArea" class="form-control" style="height: 200px; background-color: #f8f9fa; overflow-y: auto;">
                            <div class="text-muted">Click "Run Code" to see the output here...</div>
                        </div>
                    </div>

                    <!-- Execution Info -->
                    <div id="executionInfo" class="row text-muted small" style="display: none;">
                        <div class="col-md-6">
                            <i class="fas fa-clock"></i> Execution Time: <span id="executionTime">0</span>s
                        </div>
                        <div class="col-md-6">
                            <i class="fas fa-memory"></i> Memory Used: <span id="memoryUsed">0</span> bytes
                        </div>
                    </div>
                </div>
            </div>

            <!-- Code Templates -->
            <div class="card mt-4 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-book"></i> Practice Templates</h5>
                </div>
                <div class="card-body">
                    <div class="row" id="templatesContainer">
                        {% for template in templates %}
                        <div class="col-md-6 mb-3 template-item" data-category="{{ template.category }}">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">{{ template.title }}</h6>
                                    <p class="card-text text-muted">{{ template.description|truncatewords:20 }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <span class="badge bg-primary">{{ template.get_category_display }}</span>
                                            <span class="badge bg-secondary">{{ template.get_difficulty_display }}</span>
                                        </div>
                                        <a href="{% url 'compiler_template' template.id %}" class="btn btn-outline-primary btn-sm">
                                            Practice
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Executing code...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Code Editor functionality
function runCode() {
    console.log('Run Code button clicked!');
    alert('Run Code button clicked! Check console for details.');
    
    const code = document.getElementById('codeEditor').value;
    const inputData = document.getElementById('inputData').value;
    
    console.log('Code to execute:', code);
    console.log('Input data:', inputData);
    
    if (!code.trim()) {
        alert('Please enter some code to execute.');
        return;
    }
    
    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Prepare data
    const data = {
        language: 'python',
        code: code,
        input_data: inputData
    };
    
    console.log('CSRF Token:', getCookie('csrftoken'));
    console.log('Request URL:', '{% url "execute_code" %}');
    console.log('Request data:', data);
    
    // Execute code
    fetch('{% url "execute_code" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        loadingModal.hide();
        
        // Display output
        const outputArea = document.getElementById('outputArea');
        const executionInfo = document.getElementById('executionInfo');
        
        if (data.error) {
            outputArea.innerHTML = `<div class="text-danger"><strong>Error:</strong> ${data.error}</div>`;
        } else {
            outputArea.innerHTML = `<div class="text-success"><pre>${data.output || 'No output'}</pre></div>`;
        }
        
        // Show execution info
        document.getElementById('executionTime').textContent = data.execution_time || 0;
        document.getElementById('memoryUsed').textContent = data.memory_used || 0;
        executionInfo.style.display = 'block';
    })
    .catch(error => {
        loadingModal.hide();
        console.error('Error:', error);
        document.getElementById('outputArea').innerHTML = `<div class="text-danger">An error occurred: ${error.message}</div>`;
    });
}

function clearCode() {
    document.getElementById('codeEditor').value = '';
    document.getElementById('inputData').value = '';
    document.getElementById('outputArea').innerHTML = '<div class="text-muted">Click "Run Code" to see the output here...</div>';
    document.getElementById('executionInfo').style.display = 'none';
}

// Template filtering
document.addEventListener('DOMContentLoaded', function() {
    const categoryLinks = document.querySelectorAll('.filter-category');
    const templateItems = document.querySelectorAll('.template-item');
    
    categoryLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const category = this.dataset.category;
            
            // Update active state
            categoryLinks.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            
            // Filter templates
            templateItems.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    });
});

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
/* Main container spacing */
.container-fluid {
    margin-top: 2rem !important;
    padding-top: 1rem !important;
}

/* Card styling improvements */
.card {
    border: none;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    border-radius: 0.5rem 0.5rem 0 0 !important;
    border-bottom: 1px solid rgba(0, 0, 0, 0.125);
}

/* Button visibility and styling */
.btn-light {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    transition: all 0.3s ease;
}

.btn-light:hover {
    background-color: #e9ecef;
    border-color: #adb5bd;
    transform: translateY(-1px);
}

/* Force button visibility */
.btn-success, .btn-secondary, .btn-light {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
    z-index: 9999 !important;
}

/* Code Editor Styling */
#codeEditor {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

#outputArea {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #f8f9fa;
}

/* Template Cards */
.template-item {
    transition: all 0.3s ease;
}

.template-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

/* Category Filter Styling */
.filter-category {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.filter-category:hover {
    background-color: #e9ecef;
    transform: translateX(5px);
}

.filter-category.active {
    background-color: #007bff;
    color: white;
    border-color: #0056b3;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .container-fluid {
        margin-top: 1rem !important;
        padding-top: 0.5rem !important;
    }
    
    .col-md-3, .col-md-9 {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

